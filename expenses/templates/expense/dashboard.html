<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard - Expense Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset and base styles */
        /* Reset and base styles */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            margin: 0;
            padding: 0;
            color: #e8f0fe;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(30, 58, 138, 0.3);
        }

        h1 {
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        main {
            padding: 2rem;
            max-width: 1000px;
            margin: auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 8px;
        }

        .top-bar .welcome {
            font-size: 1.75rem; /* Equivalent to h2 */
            font-weight: 700;
            color: #60a5fa;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .top-bar button {
            background: linear-gradient(135deg, #3730a3 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(55, 48, 163, 0.3);
        }

        .top-bar button:hover {
            background: linear-gradient(135deg, #312e81 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(55, 48, 163, 0.4);
        }

        section {
            margin-bottom: 2rem;
        }

        h2, h3, h4 {
            color: #93c5fd;
            border-bottom: 2px solid #3730a3;
            padding-bottom: 0.5rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            margin-bottom: 0.5rem;
            padding: 1rem;
            border-left: 5px solid #3730a3;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }

        li:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(55, 48, 163, 0.2);
            border-color: #60a5fa;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #334155;
        }

        th {
            background: linear-gradient(135deg, #3730a3 0%, #1e40af 100%);
            color: white;
        }

        .highlight {
            color: #60a5fa;
            font-weight: bold;
        }

        /* Weekly Calendar Styles */
        .week-calendar {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 32px;
            text-align: center;
            overflow-x: auto;
            border: 1px solid #334155;
        }

        .week-calendar .day {
            flex: 1;
            padding: 10px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(55, 48, 163, 0.1);
        }

        .week-calendar .day:hover {
            background: rgba(96, 165, 250, 0.1);
            transform: translateY(-2px);
        }

        .week-calendar .day-name {
            display: block;
            font-weight: 600;
            color: #cbd5e1;
            font-size: 1rem;
        }

        .week-calendar .day-date {
            display: block;
            font-weight: 700;
            font-size: 1.1rem;
            color: #60a5fa;
        }

        .week-calendar .today {
            background: linear-gradient(135deg, #3730a3 0%, #1e40af 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(55, 48, 163, 0.5);
        }

        .week-calendar .today .day-name,
        .week-calendar .today .day-date {
            color: #ffffff;
        }

        /* Responsive layout for smaller screens */
        @media (max-width: 860px) {
            main {
                padding: 1rem;
            }

            th, td {
                padding: 0.5rem;
            }

            header {
                padding: 1rem;
            }

            .week-calendar {
                flex-direction: column;
            }

            .week-calendar .day {
                width: 100%;
                margin-bottom: 8px;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .summary-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            min-width: 200px;
            flex: 1;
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(55, 48, 163, 0.2);
            border-color: #60a5fa;
        }

        .summary-card h4 {
            color: #93c5fd;
            margin-bottom: 0.5rem;
            border: none;
            padding: 0;
        }

        .income-amount {
            color: #34d399;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(52, 211, 153, 0.3);
        }

        .expense-amount {
            color: #f87171;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(248, 113, 113, 0.3);
        }

        .balance-amount {
            color: #60a5fa;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(96, 165, 250, 0.3);
        }

        .form-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }

        .form-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            flex: 1 1 300px;
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .form-card:hover {
            border-color: #60a5fa;
            box-shadow: 0 6px 20px rgba(55, 48, 163, 0.2);
        }

        .form-card h4 {
            margin-top: 0;
            color: #60a5fa;
            border: none;
            padding: 0;
        }

        form input, form select, form textarea {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        form input:focus, form select:focus, form textarea:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        form label {
            color: #cbd5e1;
            font-weight: 500;
        }

        form button {
            margin-top: 1rem;
            background: linear-gradient(135deg, #3730a3 0%, #1e40af 100%);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(55, 48, 163, 0.3);
        }

        form button:hover {
            background: linear-gradient(135deg, #312e81 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(55, 48, 163, 0.4);
        }

        .goals-list {
            list-style-type: none;
            padding: 0;
            margin-top: 1rem;
        }

        .goals-list li {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            margin-bottom: 1rem;
            padding: 1rem;
            border-left: 5px solid #3730a3;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .goal-progress-bar {
            background-color: #374151;
            border-radius: 8px;
            height: 20px;
            margin: 0.5rem 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .goal-progress {
            background: linear-gradient(135deg, #3730a3 0%, #60a5fa 100%);
            height: 100%;
            color: white;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            transition: width 0.3s ease;
            box-shadow: 0 2px 4px rgba(55, 48, 163, 0.3);
        }

        .goal-actions {
            margin-top: 0.5rem;
        }

        .goal-actions a {
            margin-right: 10px;
            color: #60a5fa;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .goal-actions a:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .chart-wrapper {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .chart-wrapper:hover {
            border-color: #60a5fa;
            box-shadow: 0 6px 20px rgba(55, 48, 163, 0.2);
        }

        .expense-actions {
            margin-top: 0.5rem;
        }

        .expense-actions a {
            margin-right: 12px;
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .expense-actions a:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .button-link {
            margin-left: 10px;
            background: none;
            border: none;
            color: #60a5fa;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s ease;
        }

        .button-link:hover {
            color: #93c5fd;
        }

        .chart-wrapper canvas {
            max-height: 400px !important;
            height: 300px !important;
        }

        /* Special styling for prediction section */
        section p {
            color: #cbd5e1;
        }

        /* Error text styling */
        p[style*="color: #e74c3c"] {
            color: #f87171 !important;
        }

        /* Success text styling */
        span[style*="color: #28a745"] {
            color: #34d399 !important;
        }

        /* Warning text styling */
        span[style*="color: #e74c3c"] {
            color: #f87171 !important;
        }

        /* Help text */
        .help-text {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        /* Error list */
        .errorlist {
            color: #f87171;
            font-size: 0.875rem;
        }

        /* Income and expense items */
        .income-item {
            border-left-color: #34d399;
        }

        .expense-item {
            border-left-color: #f87171;
        }

        /* Transaction type labels */
        .transaction-type {
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .income-item .transaction-type {
            color: #34d399;
        }

        .expense-item .transaction-type {
            color: #f87171;
        }
    </style>
</head>
<body>
    <header>
    <h1>Dashboard</h1>
</header>
<main class="dashboard-container" role="main" aria-label="Dashboard - Expense Tracker">
    <div class="top-bar">
        <div class="welcome">Welcome back, {{ user.username }}!</div>
        <form class="logout-form" action="{% url 'logout' %}" method="post" aria-label="Logout form">
            {% csrf_token %}
            <button type="submit" aria-describedby="logoutDesc">Logout</button>
        </form>
    </div>

    <div class="week-calendar" id="weekCalendar"></div>

    <section aria-labelledby="today-transactions-title">
        <h3 id="today-transactions-title">Today's Transactions</h3>
        <ul class="expenses-list today-transactions-list">
            {% for transaction in today_incomes %}
                <li tabindex="0" class="income-item">
                    <div class="expense-details" aria-label="Income details">
                        <strong>{{ transaction.title }}</strong> – ₹{{ transaction.amount }} ({{ transaction.category }})
                    </div>
                    <div class="transaction-type" aria-label="Transaction type">
                        Income
                    </div>
                </li>
            {% endfor %}
            {% for transaction in today_expenses %}
                <li tabindex="0" class="expense-item">
                    <div class="expense-details" aria-label="Expense details">
                        <strong>{{ transaction.title }}</strong> – ₹{{ transaction.amount }} ({{ transaction.category }})
                    </div>
                    <div class="transaction-type" aria-label="Transaction type">
                        Expense
                    </div>
                </li>
            {% endfor %}
            {% if not today_incomes and not today_expenses %}
                <li>No transactions found for today.</li>
            {% endif %}
        </ul>
    </section>


    <section aria-labelledby="monthly-summary-title">
    <h3 id="monthly-summary-title">Monthly Summary</h3>
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; text-align: center;">
        <div class="summary-card">
            <h4>Income (Monthly)</h4>
            <p class="income-amount">₹{{ total_income|floatformat:2 }}</p>
        </div>
        <div class="summary-card">
            <h4>Expense (Monthly)</h4>
            <p class="expense-amount">₹{{ total_spent|floatformat:2 }}</p>
        </div>
        <div class="summary-card">
            <h4>Balance (Monthly)</h4>
            <p class="balance-amount">₹{{ balance|floatformat:2 }}</p>
        </div>
    </div>
</section>

<section>
    <h2>Predicted Spending & Budget</h2>
    {% if prediction_error %}
        <p style="color: #e74c3c; font-weight: bold;">Prediction Error: {{ prediction_error }}</p>
        <p>Add more expenses over several months to enable spending predictions.</p>
    {% else %}
        <p>Your predicted spending for the next month is: <strong style="color: #0077cc;">₹{{ predicted_spending|floatformat:2 }}</strong></p>
        <p>
            {% if total_spent > predicted_spending %}
                <span style="color: #e74c3c; font-weight: bold;">Warning:</span> You are currently over your predicted monthly spending.
            {% else %}
                <span style="color: #28a745; font-weight: bold;">On Track:</span> You are within your predicted monthly spending.
            {% endif %}
        </p>
    {% endif %}
</section>

<section aria-labelledby="add-transactions-title">
    <h3 id="add-transactions-title">Add New Transactions</h3>
    <div class="form-section">
        <div class="form-card">
            <h4>Add Expense</h4>
            <form method="POST" novalidate>
                {% csrf_token %}
                {{ expense_form.as_p }}
                <button type="submit" name="add_expense" aria-label="Add new expense">Add Expense</button>
            </form>
        </div>

        <div class="form-card">
            <h4>Add Income</h4>
            <form method="POST" novalidate>
                {% csrf_token %}
                {{ income_form.as_p }}
                <button type="submit" name="add_income" aria-label="Add new income">Add Income</button>
            </form>
        </div>
    </div>
</section>

<section aria-labelledby="goals-title">
    <h3 id="goals-title">Your Goals</h3>
    <div class="form-card"> {# Reusing form-card for add goal form #}
        <h4>Add New Goal</h4>
        <form method="POST" novalidate>
            {% csrf_token %}
            {% for field in goal_form %}
                <p>
                    {{ field.label_tag }}
                    {{ field }}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                    {% for error in field.errors %}
                        <span class="errorlist">{{ error }}</span>
                    {% endfor %}
                </p>
            {% endfor %}
            {% if goal_form.non_field_errors %}
                <div class="errorlist">
                    {% for error in goal_form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
            <button type="submit" name="add_goal" aria-label="Add new goal">Add Goal</button>
        </form>
    </div>

    <ul class="goals-list">
    {% for goal in goals %}
        <li tabindex="0" class="{% if goal.completed %}completed{% endif %}">
            <div class="goal-header">
                <span class="goal-name">{{ goal.name }}</span>
                <span class="goal-amounts">
                    ₹{{ goal.current_amount|floatformat:2 }} / ₹{{ goal.target_amount|floatformat:2 }}
                    {% if goal.due_date %}(by {{ goal.due_date }}){% endif %}
                </span>
            </div>
            <div class="goal-progress-bar">
                <div class="goal-progress" style="width: {{ goal.progress_percentage|floatformat:0 }}%;">
                    {{ goal.progress_percentage|floatformat:0 }}%
                </div>
            </div>
            <div class="goal-actions">
                <a href="{% url 'edit_goal' goal.id %}">Edit Goal</a>
                <a href="{% url 'delete_goal' goal.id %}">Delete Goal</a>
            </div>
        </li>
    {% empty %}
        <li style="text-align: center; color: #667788;">No goals set yet. Start saving!</li>
    {% endfor %}
</ul>
</section>


<section aria-labelledby="filter-expenses-title">
    <h3 id="filter-expenses-title">Filter Expenses by Date</h3>
    <form method="GET" action="{% url 'dashboard' %}" novalidate>
        <label for="start_date">Start Date:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date|default_if_none:'' }}" />

        <label for="end_date">End Date:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date|default_if_none:'' }}" />

        <button type="submit" aria-label="Apply date filter">Apply Filter</button>
        <a href="{% url 'dashboard' %}" class="button-link" aria-label="Clear date filter">Clear Filter</a>
    </form>
</section>

<section aria-labelledby="spending-summary-title">
    <h3 id="spending-summary-title">Spending Summary (Filtered)</h3>
    <p>Total Spent (in current filter): <strong>₹{{ total_spent|floatformat:2 }}</strong></p>
</section>

<section aria-labelledby="category-chart-title" class="chart-wrapper">
    <h4 id="category-chart-title">Spending by Category</h4>
    <canvas id="categoryChart" width="400" height="200"></canvas>
</section>

<section aria-labelledby="monthly-chart-title" class="chart-wrapper">
    <h4 id="monthly-chart-title">Monthly Spending Trend</h4>
    <canvas id="monthlyChart" width="400" height="200"></canvas>
</section>

<section aria-labelledby="expenses-list-title">
    <h3 id="expenses-list-title">Your All Expenses</h3>
    <ul class="expenses-list">
        {% for expense in expenses %}
            <li tabindex="0">
                <div class="expense-details" aria-label="Expense details">
                    <strong>{{ expense.title }}</strong> – ₹{{ expense.amount }} ({{ expense.category }}) on {{ expense.date }}
                </div>
                <div class="expense-actions" aria-label="Expense actions">
                    <a href="{% url 'edit_expense' expense.id %}">Edit Expense</a>
                    <a href="{% url 'delete_expense' expense.id %}">Delete Expense</a>
                </div>
            </li>
        {% empty %}
            <li>No expenses recorded yet.</li>
        {% endfor %}
    </ul>
</section>

</main>

<script>
    // Live calendar generation (This part remains the same)
    const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const calendarContainer = document.getElementById('weekCalendar');
    const today = new Date();
    const todayIndex = today.getDay();

    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - todayIndex);

    for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const dayName = weekDays[date.getDay()];
        const dayDate = date.getDate();

        const dayDiv = document.createElement('div');
        dayDiv.className = 'day' + (i === todayIndex ? ' today' : '');

        const nameSpan = document.createElement('span');
        nameSpan.className = 'day-name';
        nameSpan.textContent = dayName;

        const dateSpan = document.createElement('span');
        dateSpan.className = 'day-date';
        dateSpan.textContent = dayDate;

        dayDiv.appendChild(nameSpan);
        dayDiv.appendChild(dateSpan);

        calendarContainer.appendChild(dayDiv);
    }
    
    // --- DYNAMIC CHART DATA ---
    // The data is now being passed from your Django view and rendered as a JSON string.
    // We use JSON.parse() to convert the string back into a JavaScript object.
    const categoryLabels = JSON.parse('{{ category_labels|safe }}');
    const categoryData = JSON.parse('{{ category_data|safe }}');

    const monthlyLabels = JSON.parse('{{ monthly_labels|safe }}');
    const monthlyData = JSON.parse('{{ monthly_data|safe }}');
    
    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: categoryLabels, // Use the dynamic labels
            datasets: [{
                label: 'Expenses by Category (₹)',
                data: categoryData, // Use the dynamic data
                backgroundColor: ['#0077cc', '#3399ff', '#66b3ff', '#99ccff']
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyLabels, // Use the dynamic labels
            datasets: [{
                label: 'Monthly Spending (₹)',
                data: monthlyData, // Use the dynamic data
                borderColor: '#0077cc',
                backgroundColor: 'rgba(0, 119, 204, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

</script>
</body>
</html>